import { NotAcceptableException, Req } from '@nestjs/common';
import { Rooms, userDto } from './chatRoom.dto';
import {
	ConnectedSocket,
	MessageBody,
	OnGatewayConnection,
	OnGatewayDisconnect,
	OnGatewayInit,
	SubscribeMessage,
	WebSocketGateway,
	WebSocketServer,
} from '@nestjs/websockets';
import { Socket, Server } from 'socket.io';
import { AuthService } from 'src/auth/auth.service';
import { UserService } from 'src/user/user.service';
import { Injectable } from '@nestjs/common';

@Injectable()
@WebSocketGateway({
	cors: { origin: 'http://localhost:4200' },
	namespace: "/chat"
	// cors: { origin: '/frontend' }, (might be better?)
})

export class ChatGateway implements OnGatewayInit, OnGatewayConnection, OnGatewayDisconnect {

	@WebSocketServer() 
	io: Server;
	chatRoomList: Record<string, Rooms>;
  	userList: Record<string, userDto>;
	users: string[];
	constructor(private authService: AuthService, private userService: UserService) {
		this.chatRoomList = {
			lobby: {
			  id: 'lobby',
			  roomName: 'lobby',
			  admins: [],
			  banned: [],
			  muted: [],
			  password: undefined,
			},
		  };
		this.userList = {};
	}

	afterInit() {
		console.log("server initialized");
	}

	async handleConnection(client: Socket) {
		try {
			console.log(client.id, "connecting...");
			const cookies = client.handshake.headers.cookie?.split('; ');
			if (!cookies)
				throw new NotAcceptableException();
			var token: string;
			for (var cookie of cookies) {
				const [key, value] = cookie.split('=');
				// console.log(value);
				if (key === 'access_token') {
					token = value;
					break;
				}
			}
			if (!token)
				throw new NotAcceptableException();
			const payload = await this.authService.verifyJwtAccessToken(token);
			const user = await this.userService.findUserById(payload.id);
			if (!user)
				throw new NotAcceptableException();
			client.data.nickname = user.nickname;
			this.users.push(user.nickname);
			console.log(user.nickname, "connected on socket:", client.id);
			// const rooms = this.io.sockets.adapter.rooms;
		  	client.emit('getRooms', Array.from(client.rooms));
			client.emit('getConnectedUsers', this.users);
			console.log(Array.from(client.rooms))
		  	// console.log('roomList: ' +  Array.from(rooms.keys()));
			// const sockets = await io.fetchSockets();
			// this.createRoom({id: "test1", password :""}, client);
			// this.createRoom({id: "Global Chat", password :""}, client);
		} catch {
			console.log(client.id, "connection refused");
			client.disconnect();
			return;
		}
		
	}
	
	handleDisconnect(client: any) {
		console.log("chat: user " + client.id + " disconnected");
		client.emit('getRooms', Array.from(client.rooms));
	}
	
	
	// @SubscribeMessage('message')
	// async handleMessage(
	// 	@MessageBody() data: string,
	// 	@ConnectedSocket() client: Socket
	// ) {
	// 	console.log('chat: message recieved from ' + client.data.nickname + ': ' + data);
	// 	client.broadcast.emit('message', client.data.nickname + ": " + data);
		
	// 	return data;
	// }

	@SubscribeMessage('message')
	async handleMessage(
		@MessageBody() data: { message: string, sender: string },
		@ConnectedSocket() socket: Socket,
	) {
		const nickname = socket.data.nickname;
		const message = data.message;
		const chatRoom = this.chatRoomList[socket.data.id];
		this.io
		.to(socket.data.id)
		.emit('message', { nickname: nickname, message: message });
		console.log("send message: " + socket.data.id + ", nickname: " + nickname + ", msg: " + message + ", chat name: " + socket.id )
	}

	@SubscribeMessage('createRoom')
	async createRoom(
	@MessageBody() data: { id: string; password: string },
	@ConnectedSocket() socket: Socket,
	) {
		console.log("createRoom called: " + data.id);
		
		const id = data.id;
		socket.data.id = id;
		socket.data.roomName = id;
		this.chatRoomList[id] = {
			id: id,
			roomName: id,
			admins: [socket.data.nickname],
			banned: [],
			muted: [],
			password: data.password,
		};
		if (!this.userList[socket.data.nickname]) {
			this.userList[socket.data.nickname] = {
			  id: '',
			  nickname: socket.data.nickname,
			  socketId: socket.id,
			  isAdmin: false,
			};
		  }
		this.userList[socket.data.nickname].id = id;
		this.userList[socket.data.nickname].isAdmin = true;
		socket.join(id);
		// socket.emit('joinRoom', { roomName: id });
		// this.io.to(socket.data.id).emit('addUser', socket.data.nickname);
		this.channelUserList(id);	
		// socket.emit('isAdmin');
		console.log('roomList: ' +  Array.from(socket.rooms));
		// console.log('roomList: ' +  Array.from(socket.rooms)[1]);
		console.log('socket nickname: ' +  socket.data.id);


		// console.log('roomList: ' + (Object.keys(socket.rooms)));
		// for (const value of socket.rooms) {
		// 	console.log(value);
		//   }

		socket.emit('getRooms', Array.from(socket.rooms).slice(1));
	}

	async channelUserList(id: string) {
		const users = [];
		// const sockets = this.io.sockets.adapter.rooms.get(id);
		// const sockets = await this.io.of("/chat").in(id).allSockets();
		const sockets = await this.io.in(id).fetchSockets();
		if (!sockets)
		  return;
		sockets.forEach((obj) => {
			users.push(obj.id);
			console.log("user: " + obj.data.nickname);
		});
		this.io.to(id).emit('userList', users);
		console.log("channelUserList: " + users);
	}

	@SubscribeMessage('joinRoom')
	async joinRoom(
	@MessageBody() data: { id: string, password: string },
	@ConnectedSocket() socket: Socket,
	) {
		console.log("joinRoom api: " + data.id);
		const id = data.id;
		const Room = Object.values(this.chatRoomList).find(
			(room) => room.id === id,
		);
		if (Room === undefined) {
			socket.emit('errorMessage', 'The room does not exists.',);
			return;
		}
		else if (Room.id === socket.data.id) {
			socket.emit('systemMessage', 'You have already entered the room.');
			return;
		}
		socket.data.id = id;
		socket.data.roomName = id;
		socket.join(id);
		this.userList[socket.data.nickname].id = id;
		// socket.emit('joinRoom', { roomName: id });
		console.log("joinroom: " + id);
		// this.io.to(socket.data.id).emit('addUser', socket.data.nickname);
		this.channelUserList(id);
	}
	// check pw
	@SubscribeMessage('joinPrivateRoom') async joinPrivateRoom(){}
	@SubscribeMessage('leaveRoom') async leaveChannel() {
		// async leaveRoom(client: Socket, room: string): void {
		// 	client.leave(room);
	}
	@SubscribeMessage('addAdmin') async addAdmins() {}
	@SubscribeMessage('removeAdmin') async removeAdmins() {}
	@SubscribeMessage('changePassword') async changePassword() {}
	@SubscribeMessage('mute') async mute() {}
	@SubscribeMessage('unMute') async unMute() {}
	@SubscribeMessage('ban') async ban() {}
	@SubscribeMessage('unBan') async unban() {}
}
